knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
fig.width = 12,
fig.height = 7
)
#| label: fig-enrollment
#| fig-cap: "Interactive chart showing primary enrollment rates (primratio) across countries. Highlighted countries include Brazil, Mexico, and major European nations. Hover over lines to see detailed information."
# =========================================================================
# Interactive Chart: Primary Enrollment Rate by Country
# Comparative Analysis of Enrollment Rates (primratio)
# =========================================================================
# =========================================================================
# 1. Load Required Libraries
# =========================================================================
library(tidyverse)
library(plotly)
library(htmlwidgets)
library(RColorBrewer)
library(haven)
options(scipen = 999)
# =========================================================================
# 2. Import Dataset
# =========================================================================
# Import Stata .dta file
Civil_War_and_Primary_Enrollment_firstwar_APSR <- read_dta("Civil War and Primary Enrollment_firstwar_APSR.dta")
# Civil_War_and_Primary_Enrollment_firstwar_APSR <- read_dta("posts/2026_01_20_Comment_on_Paglayan/Civil War and Primary Enrollment_firstwar_APSR.dta")
# =========================================================================
# 3. Prepare Data
# =========================================================================
# Define countries to highlight
highlight_countries <- c("BRA", "MEX", "GBR", "ESP", "PRT", "SWE", "URY", "DEU", "FRA")
# Prepare dataset
table <- Civil_War_and_Primary_Enrollment_firstwar_APSR %>%
filter(!is.na(primratio), !is.na(year)) %>%
mutate(
Country_Color = ifelse(WDICountryVWCode %in% highlight_countries,
WDICountryVWCode,
"Other"),
hover_text = paste(
"Country:", WDICountryVWCode, "<br>",
"Year:", year, "<br>",
"Enrollment Rate:", round(primratio, 2)
)
)
# =========================================================================
# 4. Define Color Palette
# =========================================================================
highlight_colors <- brewer.pal(length(highlight_countries), "Set1")
names(highlight_colors) <- highlight_countries
all_colors <- c(highlight_colors, "Other" = "grey70")
# =========================================================================
# 5. Create Interactive Chart with Plotly
# =========================================================================
# Create empty figure
fig <- plot_ly(type = 'scatter', mode = 'lines')
# Add lines for "Other" countries (grey, faded)
data_other <- table %>% filter(Country_Color == "Other")
for (country in unique(data_other$WDICountryVWCode)) {
data_country <- data_other %>% filter(WDICountryVWCode == country)
fig <- fig %>%
add_trace(
data = data_country,
x = ~year,
y = ~primratio,
name = country,
legendgroup = "Other",
showlegend = FALSE,
hoverinfo = 'text',
text = ~hover_text,
line = list(
color = "grey70",
width = 0.8
),
opacity = 0.2
)
}
# Add lines for highlighted countries
for (country in highlight_countries) {
data_country <- table %>% filter(WDICountryVWCode == country)
if (nrow(data_country) > 0) {
fig <- fig %>%
add_trace(
data = data_country,
x = ~year,
y = ~primratio,
name = country,
legendgroup = country,
showlegend = TRUE,
hoverinfo = 'text',
text = ~hover_text,
line = list(
color = all_colors[country],
width = 2.5
)
)
}
}
# =========================================================================
# 6. Configure Chart Layout
# =========================================================================
# Calcular range com verificação de segurança
year_range <- range(table$year, na.rm = TRUE)
# Verificar se temos dados válidos
if (length(year_range) == 2 && !any(is.infinite(year_range))) {
year_min <- floor(year_range[1] / 20) * 20
year_max <- ceiling(year_range[2] / 20) * 20
} else {
# Valores padrão caso não haja dados
year_min <- 1800
year_max <- 2020
warning("Could not determine year range from data. Using default values.")
}
fig <- fig %>%
layout(
xaxis = list(
title = list(text = "Year", font = list(family = "Arial", size = 14)),
tickvals = seq(year_min, year_max, by = 20),
tickfont = list(family = "Arial", size = 12),
showgrid = TRUE,
gridwidth = 1,
gridcolor = "rgba(200, 200, 200, 0.3)"
),
yaxis = list(
title = list(text = "Primary Enrollment Rate (primratio)",
font = list(family = "Arial", size = 14)),
tickfont = list(family = "Arial", size = 12),
showgrid = TRUE,
gridwidth = 1,
gridcolor = "rgba(200, 200, 200, 0.3)"
),
legend = list(
orientation = "v",
x = 1.02,
xanchor = "left",
y = 1,
yanchor = "top",
title = list(text = "Country"),
font = list(family = "Arial", size = 11),
bgcolor = "rgba(255, 255, 255, 0.9)",
bordercolor = "rgba(0, 0, 0, 0.2)",
borderwidth = 1
),
font = list(family = "Arial", size = 12),
hovermode = 'closest',
margin = list(r = 150, l = 70, t = 50, b = 70),
plot_bgcolor = "rgba(250, 250, 250, 0.8)",
paper_bgcolor = "white",
height = 550
)
# =========================================================================
# 7. Add Hover Highlight Effect
# =========================================================================
js_code <- "
function(el, x) {
var originalStyles = {};
for (var i = 0; i < x.data.length; i++) {
originalStyles[i] = {
color: x.data[i].line.color,
width: x.data[i].line.width,
opacity: x.data[i].opacity || 1
};
}
el.on('plotly_hover', function(data) {
var trace_index = data.points.curveNumber;
Plotly.restyle(el, {
'line.width': 4,
'line.color': 'black',
'opacity': 1
}, trace_index);
});
el.on('plotly_unhover', function(data) {
var trace_index = data.points.curveNumber;
var originalStyle = originalStyles[trace_index];
Plotly.restyle(el, {
'line.width': originalStyle.width,
'line.color': originalStyle.color,
'opacity': originalStyle.opacity
}, trace_index);
});
}
"
# =========================================================================
# 8. Render Final Chart
# =========================================================================
fig_final <- fig %>% onRender(js_code)
fig_final
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
fig.width = 12,
fig.height = 7
)
#| label: fig-enrollment
#| fig-cap: "Interactive chart showing primary enrollment rates (primratio) across countries. Highlighted countries include Brazil, Mexico, and major European nations. Hover over lines to see detailed information."
# =========================================================================
# Interactive Chart: Primary Enrollment Rate by Country
# Comparative Analysis of Enrollment Rates (primratio)
# =========================================================================
# =========================================================================
# 1. Load Required Libraries
# =========================================================================
library(tidyverse)
library(plotly)
library(htmlwidgets)
library(RColorBrewer)
library(haven)
options(scipen = 999)
# =========================================================================
# 2. Import Dataset
# =========================================================================
# Import Stata .dta file
Civil_War_and_Primary_Enrollment_firstwar_APSR <- read_dta("Civil War and Primary Enrollment_firstwar_APSR.dta")
# Civil_War_and_Primary_Enrollment_firstwar_APSR <- read_dta("posts/2026_01_20_Comment_on_Paglayan/Civil War and Primary Enrollment_firstwar_APSR.dta")
# =========================================================================
# 3. Prepare Data
# =========================================================================
# Define countries to highlight
highlight_countries <- c("BRA", "MEX", "GBR", "ESP", "PRT", "SWE", "URY", "DEU", "FRA")
# Prepare dataset
table <- Civil_War_and_Primary_Enrollment_firstwar_APSR %>%
filter(!is.na(primratio), !is.na(year)) %>%
mutate(
Country_Color = ifelse(WDICountryVWCode %in% highlight_countries,
WDICountryVWCode,
"Other"),
hover_text = paste(
"Country:", WDICountryVWCode, "<br>",
"Year:", year, "<br>",
"Enrollment Rate:", round(primratio, 2)
)
)
# =========================================================================
# 4. Define Color Palette
# =========================================================================
highlight_colors <- brewer.pal(length(highlight_countries), "Set1")
names(highlight_colors) <- highlight_countries
all_colors <- c(highlight_colors, "Other" = "grey70")
# =========================================================================
# 5. Create Interactive Chart with Plotly
# =========================================================================
# Create empty figure
fig <- plot_ly(type = 'scatter', mode = 'lines')
# Add lines for "Other" countries (grey, faded)
data_other <- table %>% filter(Country_Color == "Other")
for (country in unique(data_other$WDICountryVWCode)) {
data_country <- data_other %>% filter(WDICountryVWCode == country)
fig <- fig %>%
add_trace(
data = data_country,
x = ~year,
y = ~primratio,
name = country,
legendgroup = "Other",
showlegend = FALSE,
hoverinfo = 'text',
text = ~hover_text,
line = list(
color = "grey70",
width = 0.8
),
opacity = 0.2
)
}
# Add lines for highlighted countries
for (country in highlight_countries) {
data_country <- table %>% filter(WDICountryVWCode == country)
if (nrow(data_country) > 0) {
fig <- fig %>%
add_trace(
data = data_country,
x = ~year,
y = ~primratio,
name = country,
legendgroup = country,
showlegend = TRUE,
hoverinfo = 'text',
text = ~hover_text,
line = list(
color = all_colors[country],
width = 2.5
)
)
}
}
# =========================================================================
# 6. Configure Chart Layout
# =========================================================================
# Calcular range com verificação de segurança
year_range <- range(table$year, na.rm = TRUE)
# Verificar se temos dados válidos
if (length(year_range) == 2 && !any(is.infinite(year_range))) {
year_min <- floor(year_range[1] / 20) * 20
year_max <- ceiling(year_range[2] / 20) * 20
} else {
# Valores padrão caso não haja dados
year_min <- 1800
year_max <- 2020
warning("Could not determine year range from data. Using default values.")
}
fig <- fig %>%
layout(
xaxis = list(
title = list(text = "Year", font = list(family = "Arial", size = 14)),
tickvals = seq(year_min, year_max, by = 20),
tickfont = list(family = "Arial", size = 12),
showgrid = TRUE,
gridwidth = 1,
gridcolor = "rgba(200, 200, 200, 0.3)"
),
yaxis = list(
title = list(text = "Primary Enrollment Rate (primratio)",
font = list(family = "Arial", size = 14)),
tickfont = list(family = "Arial", size = 12),
showgrid = TRUE,
gridwidth = 1,
gridcolor = "rgba(200, 200, 200, 0.3)"
),
legend = list(
orientation = "v",
x = 1.02,
xanchor = "left",
y = 1,
yanchor = "top",
title = list(text = "Country"),
font = list(family = "Arial", size = 11),
bgcolor = "rgba(255, 255, 255, 0.9)",
bordercolor = "rgba(0, 0, 0, 0.2)",
borderwidth = 1
),
font = list(family = "Arial", size = 12),
hovermode = 'closest',
margin = list(r = 150, l = 70, t = 50, b = 70),
plot_bgcolor = "rgba(250, 250, 250, 0.8)",
paper_bgcolor = "white",
height = 550
)
# =========================================================================
# 7. Add Hover Highlight Effect
# =========================================================================
js_code <- "
function(el, x) {
var originalStyles = {};
for (var i = 0; i < x.data.length; i++) {
originalStyles[i] = {
color: x.data[i].line.color,
width: x.data[i].line.width,
opacity: x.data[i].opacity || 1
};
}
el.on('plotly_hover', function(data) {
var trace_index = data.points.curveNumber;
Plotly.restyle(el, {
'line.width': 4,
'line.color': 'black',
'opacity': 1
}, trace_index);
});
el.on('plotly_unhover', function(data) {
var trace_index = data.points.curveNumber;
var originalStyle = originalStyles[trace_index];
Plotly.restyle(el, {
'line.width': originalStyle.width,
'line.color': originalStyle.color,
'opacity': originalStyle.opacity
}, trace_index);
});
}
"
# =========================================================================
# 8. Render Final Chart
# =========================================================================
fig_final <- fig %>% onRender(js_code)
fig_final
print(fig_final)
